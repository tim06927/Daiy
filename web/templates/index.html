<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bike Components Shop ‚Äì AI Recommendations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #ffffff;
      --surface: #f8f8f8;
      --accent: #000000;
      --accent-hover: #333333;
      --text: #111111;
      --text-secondary: #666666;
      --border: #e0e0e0;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    /* Header */
    .header {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.98);
    }

    .header-content {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
      text-decoration: none;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      letter-spacing: -0.5px;
    }

    .logo-text {
      display: inline-flex;
      align-items: baseline;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      line-height: 1.3;
    }

    .header-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .nav {
      display: flex;
      gap: 1.5rem;
      list-style: none;
      flex-wrap: wrap;
    }

    .nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      transition: color 0.15s;
    }

    .nav a:hover {
      color: var(--text);
    }

    /* Hero Search Section */
    .hero {
      background: linear-gradient(to bottom, var(--bg), var(--surface));
      padding: 1.5rem 2rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .hero-content {
      max-width: 1280px;
      margin: 0 auto;
    }

    .hero-subtitle {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
      letter-spacing: 0.3px;
    }

    /* Search Mode Tabs */
    .search-modes-inline {
      position: absolute;
      left: 0.8rem;
      top: 0.5rem;
      display: flex;
      gap: 0.3rem;
      z-index: 2;
    }

    .mode-tab {
      padding: 0.4rem 0.8rem;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.15s;
      line-height: 1.2;
      position: relative;
      outline: 2px solid transparent;
      outline-offset: 2px;
    }

    .mode-tab:focus {
      outline-color: var(--accent);
      border-radius: 4px;
    }

    .mode-tab:hover {
      color: var(--text);
    }

    .mode-tab.active {
      color: var(--text);
      font-weight: 600;
    }

    .mode-tab.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--text);
    }

    .mode-tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Search Container */
    .search-container {
      position: relative;
      max-width: 920px;
      margin: 0 auto;
    }

    .search-wrapper {
      position: relative;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      padding-right: 0.5rem;
      padding-left: 4.5rem;
    }

    .search-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: var(--shadow-lg);
    }

    .search-wrapper:has(.search-input:focus) {
      outline: 2px solid var(--accent);
      outline-offset: 0px;
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 1rem 1.25rem 1rem 3.25rem;
      font-size: 1rem;
      background: transparent;
      resize: none;
      overflow: hidden;
      font-family: inherit;
      line-height: 1.5;
      color: var(--text);
      min-height: auto;
      max-height: 200px;
    }

    .upload-input {
      display: none;
    }

    .upload-btn {
      position: absolute;
      left: 1.25rem;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.15s;
      z-index: 2;
    }

    .upload-btn:hover {
      background: var(--bg);
      color: var(--text);
      border-color: var(--accent);
    }

    .upload-status {
      margin-top: 0.35rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-height: 1rem;
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .search-input.multi-line {
      min-height: 1.5rem;
      padding: 0.9rem 1.25rem;
    }

    .search-button {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 6px;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
      margin-right: 0.25rem;
      position: relative;
      outline: 2px solid transparent;
      outline-offset: 2px;
    }

    .search-button:focus {
      outline-color: var(--accent);
    }

    .search-button.loading {
      color: transparent;
    }

    .search-button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .search-button:hover {
      background: var(--accent-hover);
    }

    .search-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Status Message */
    .status-message {
      text-align: center;
      margin-top: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-height: 1.2rem;
    }

    .status-message.error {
      color: #dc2626;
    }

    /* Clarification Section */
    .clarification {
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 0.75rem;
      display: none;
    }

    .clarification.active {
      display: block;
    }

    .clarification-title {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text);
      font-size: 0.95rem;
    }

    .clarification-section {
      margin-bottom: 1rem;
    }

    .clarification-section:last-child {
      margin-bottom: 0;
    }

    .clarification-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.6rem;
      display: block;
    }

    .clarification-options {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .option-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.15s;
    }

    .option-btn:hover {
      background: var(--surface);
      border-color: var(--accent);
    }

    .option-selected {
      padding: 0.5rem 1rem;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Main Content */
    .main-content {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.25rem 2rem;
    }

    /* AI Results Section */
    .ai-results {
      display: none;
      margin-bottom: 1.25rem;
    }

    .ai-results.active {
      display: block;
    }

    .insight-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0;
    }

    .insight-tab {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 0;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }

    .insight-tab:hover {
      color: var(--text);
    }

    .insight-tab.active {
      color: var(--text);
      font-weight: 600;
    }

    .insight-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--text);
    }

    .insight-panels {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0.75rem 0;
      box-shadow: none;
    }

    .insight-panel {
      display: none;
    }

    .insight-panel.active {
      display: block;
    }

    .info-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.95rem;
    }

    .info-list {
      margin: 0.3rem 0 0;
      padding-left: 1.25rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .info-list li {
      margin-bottom: 0.2rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.35rem 0.75rem;
      background: var(--surface);
      color: var(--text);
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* Product Rows */
    .products-section {
      margin-top: 0.75rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
      margin-top: 1rem;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.5px;
    }

    .section-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .category-row {
      margin-bottom: 1.5rem;
    }

    .category-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .category-name {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--text);
    }

    .product-row {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 0.8rem;
      align-items: stretch;
    }

    .best-card {
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      position: relative;
    }

    .best-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .alternatives-scroll {
      overflow-x: auto;
      padding-bottom: 0;
      scroll-behavior: smooth;
    }

    .alternatives-scroll::-webkit-scrollbar {
      height: 4px;
    }

    .alternatives-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .alternatives-scroll::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .alternatives-list {
      display: flex;
      gap: 0.75rem;
      min-height: 100%;
    }

    .alt-card {
      min-width: 220px;
      max-width: 280px;
      flex: 0 0 auto;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .product-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.15s;
      text-decoration: none;
      color: inherit;
      display: block;
      position: relative;
    }

    .product-card:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .product-image {
      width: 100%;
      height: 180px;
      background: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 2.5rem;
      border-bottom: 1px solid var(--border);
    }

    .product-body {
      padding: 1.25rem;
    }

    .product-category {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
      letter-spacing: 0.5px;
    }

    .product-category.chain {
      color: var(--text-secondary);
    }

    .product-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      line-height: 1.4;
      color: var(--text);
    }

    .product-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .product-price {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .product-link {
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: color 0.15s;
    }

    .product-link:hover {
      color: var(--text);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        padding: 0 1rem;
      }

      .nav {
        display: none;
      }

      .main-content {
        padding: 1.5rem 1rem;
      }

      .hero {
        padding: 1.5rem 1rem;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
      }

      .product-row {
        grid-template-columns: 1fr;
      }

      .search-wrapper {
        padding-left: 4.5rem;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .insight-tab {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">
        üö¥
        <span class="logo-text">
          <span class="header-title">BikeShop</span>
          <span class="header-subtitle">A Snap-to-Cart bike shop. Translate your job into workflow and shopping cart.</span>
        </span>
      </a>
      <nav>
        <ul class="nav">
          <li><a href="#products">Products</a></li>
          <li><a href="#categories">Categories</a></li>
          <li><a href="#support">Support</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Hero Search Section -->
  <section class="hero">
    <div class="hero-content">
      <!-- Search Container -->
      <div class="search-container">
        <div class="search-modes-inline">
          <button class="mode-tab disabled" id="search-tab" onclick="switchMode('search')">Search</button>
          <button class="mode-tab active" id="ai-tab" onclick="switchMode('ai')">AI</button>
        </div>
        <p class="hero-subtitle">AI-powered bike component matching, currently only: replacing bike drivetrains/cassetts.</p>
        <div class="search-wrapper">
          <input id="upload-input" class="upload-input" type="file" accept="image/*" />
          <button id="upload-btn" class="upload-btn" type="button" onclick="triggerUpload()">üìé</button>
          <textarea 
            id="search-input" 
            class="search-input multi-line" 
            placeholder="Describe your bike and what you need... (e.g., 'I have a Shimano 11-speed gravel bike and need easier gears for climbs')"
            rows="1"
          ></textarea>
          <button id="search-btn" class="search-button" onclick="handleSearch()">
            ‚Üí
          </button>
        </div>
        <div id="status" class="status-message"></div>
        <div id="upload-status" class="upload-status"></div>

        <!-- Clarification Section -->
        <div id="clarification" class="clarification">
          <div class="clarification-title" id="clarification-hint">Please select the missing information:</div>
          
          <div id="speed-section" class="clarification-section" style="display:none;">
            <div class="clarification-label">Drivetrain Speed:</div>
            <div id="speed-options" class="clarification-options"></div>
          </div>

          <div id="usecase-section" class="clarification-section" style="display:none;">
            <div class="clarification-label">Use Case:</div>
            <div id="usecase-options" class="clarification-options"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="main-content">
    <!-- AI Results (hidden by default) -->
    <div id="ai-results" class="ai-results">
      <div class="insight-tabs">
        <button class="insight-tab active" id="tab-why" onclick="switchInsight('why')">Why it fits</button>
        <button class="insight-tab" id="tab-workflow" onclick="switchInsight('workflow')">Workflow</button>
        <button class="insight-tab" id="tab-checklist" onclick="switchInsight('checklist')">Checklist</button>
      </div>
      <div class="insight-panels">
        <div class="insight-panel active" id="panel-why">
          <div class="info-title">Why it fits</div>
          <ul id="why-body" class="info-list"></ul>
        </div>
        <div class="insight-panel" id="panel-workflow">
          <div class="info-title">üõ†Ô∏è Suggested workflow</div>
          <ol id="workflow-list" class="info-list"></ol>
        </div>
        <div class="insight-panel" id="panel-checklist">
          <div class="info-title">‚úÖ Checklist</div>
          <ul id="checklist-list" class="info-list"></ul>
        </div>
      </div>

      <div class="section-header">
        <div>
          <h2 class="section-title">Recommended Products</h2>
          <p class="section-subtitle">Based on your requirements</p>
        </div>
      </div>
      <div id="product-rows"></div>
    </div>

  </main>

  <script>
    // ========== STATE & ELEMENTS ==========
    let currentMode = 'ai';
    let selectedSpeed = null;
    let selectedUseCase = null;

    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const statusEl = document.getElementById('status');
    const uploadInput = document.getElementById('upload-input');
    const uploadStatus = document.getElementById('upload-status');
    const clarificationEl = document.getElementById('clarification');
    const aiResultsEl = document.getElementById('ai-results');
    const whyBody = document.getElementById('why-body');
    const workflowList = document.getElementById('workflow-list');
    const checklistList = document.getElementById('checklist-list');
    const productRowsEl = document.getElementById('product-rows');
    let activeInsight = 'why';
    let compressedImage = null;

    // ========== MODE SWITCHING ==========
    function switchMode(mode) {
      if (mode === 'search') {
        // Search is dummy for now
        return;
      }
      
      currentMode = mode;
      document.getElementById('search-tab').classList.toggle('active', mode === 'search');
      document.getElementById('ai-tab').classList.toggle('active', mode === 'ai');
      
      if (mode === 'ai') {
        searchInput.classList.add('multi-line');
        searchInput.placeholder = "Describe your bike and what you need... (e.g., 'I have a Shimano 11-speed gravel bike and need easier gears for climbs')";
        searchInput.rows = 3;
      } else {
        searchInput.classList.remove('multi-line');
        searchInput.placeholder = "Search for components...";
        searchInput.rows = 1;
      }
    }

    // ========== SEARCH & API REQUEST ==========
    async function handleSearch() {
      const problemText = searchInput.value.trim();
      
      if (!problemText) {
        statusEl.textContent = "Please describe your bike and project first.";
        statusEl.classList.add('error');
        return;
      }

      statusEl.classList.remove('error');
      statusEl.textContent = "";
      searchBtn.disabled = true;
      searchBtn.classList.add('loading');

      const finalSpeed = selectedSpeed;
      const finalUseCase = selectedUseCase;

      try {
        const resp = await fetch("/api/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            problem_text: problemText,
            selected_speed: finalSpeed,
            selected_use_case: finalUseCase,
            image_base64: compressedImage,
          }),
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || `Server error (${resp.status})`);
        }

        const data = await resp.json();

        // Persist any inferred values the backend already determined
        if (!selectedSpeed && data.inferred_speed) {
          selectedSpeed = data.inferred_speed;
        }
        if (!selectedUseCase && data.inferred_use_case) {
          selectedUseCase = data.inferred_use_case;
        }

        if (data.need_clarification) {
          statusEl.textContent = "Please select the missing information below.";
          renderClarification(data.options || {}, data.missing || []);
          return;
        }

        // Show AI results
        showAIResults(data);

      } catch (error) {
        statusEl.textContent = "Error: " + error.message;
        statusEl.classList.add('error');
      } finally {
        searchBtn.disabled = false;
        searchBtn.classList.remove('loading');
      }
    }

    // ========== CLARIFICATION OPTIONS ==========
    function renderClarification(options, missingKeys) {
      clarificationEl.classList.add('active');
      
      const speedSection = document.getElementById('speed-section');
      const usecaseSection = document.getElementById('usecase-section');
      const speedOptions = document.getElementById('speed-options');
      const usecaseOptions = document.getElementById('usecase-options');

      // Update hint
      const stillMissing = missingKeys.filter(key => {
        if (key === "drivetrain_speed") return !selectedSpeed;
        if (key === "use_case") return !selectedUseCase;
        return true;
      });
      
      if (stillMissing.length > 1) {
        document.getElementById('clarification-hint').textContent = "Please select both options to continue:";
      } else {
        document.getElementById('clarification-hint').textContent = "Please select one option to continue:";
      }

      // Speed options
      if (missingKeys.includes("drivetrain_speed")) {
        speedSection.style.display = 'block';
        speedOptions.innerHTML = '';
        
        if (selectedSpeed) {
          const selected = document.createElement("div");
          selected.className = "option-selected";
          selected.textContent = `‚úì Selected: ${selectedSpeed}-speed`;
          speedOptions.appendChild(selected);
        } else {
          (options.speed_options || []).forEach((opt) => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.textContent = opt;
            btn.onclick = () => selectSpeed(opt);
            speedOptions.appendChild(btn);
          });
        }
      } else {
        speedSection.style.display = 'none';
      }

      // Use case options
      if (missingKeys.includes("use_case")) {
        usecaseSection.style.display = 'block';
        usecaseOptions.innerHTML = '';
        
        if (selectedUseCase) {
          const selected = document.createElement("div");
          selected.className = "option-selected";
          selected.textContent = `‚úì Selected: ${selectedUseCase}`;
          usecaseOptions.appendChild(selected);
        } else {
          (options.use_case_options || []).forEach((opt) => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.textContent = opt;
            btn.onclick = () => selectUseCase(opt);
            usecaseOptions.appendChild(btn);
          });
        }
      } else {
        usecaseSection.style.display = 'none';
      }
    }

    // ========== SPEED & USE CASE SELECTION ==========
    function selectSpeed(speed) {
      selectedSpeed = parseInt(speed);
      
      // Lock in the selection visually
      const speedOptions = document.getElementById('speed-options');
      speedOptions.innerHTML = '';
      const selected = document.createElement("div");
      selected.className = "option-selected";
      selected.textContent = `‚úì Selected: ${selectedSpeed}-speed`;
      speedOptions.appendChild(selected);
      
      handleSearch();
    }

    // Select use case option
    function selectUseCase(useCase) {
      selectedUseCase = useCase;
      
      // Lock in the selection visually
      const usecaseOptions = document.getElementById('usecase-options');
      usecaseOptions.innerHTML = '';
      const selected = document.createElement("div");
      selected.className = "option-selected";
      selected.textContent = `‚úì Selected: ${selectedUseCase}`;
      usecaseOptions.appendChild(selected);
      
      handleSearch();
    }

    // ========== INSIGHT TABS & SECTIONS ==========
    function switchInsight(key) {
      activeInsight = key;
      const tabs = ['why', 'workflow', 'checklist'];
      tabs.forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('active', t === key);
        document.getElementById(`panel-${t}`).classList.toggle('active', t === key);
      });
    }

    function renderSections(sections) {
      const whyList = Array.isArray(sections.why_it_fits) ? sections.why_it_fits : [];
      const workflow = Array.isArray(sections.suggested_workflow) ? sections.suggested_workflow : [];
      const checklist = Array.isArray(sections.checklist) ? sections.checklist : [];

      // Why
      whyBody.innerHTML = '';
      whyList.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        whyBody.appendChild(li);
      });

      // Workflow
      workflowList.innerHTML = '';
      workflow.forEach(step => {
        const li = document.createElement('li');
        li.textContent = step;
        workflowList.appendChild(li);
      });

      // Checklist
      checklistList.innerHTML = '';
      checklist.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        checklistList.appendChild(li);
      });

      // Reset to first tab on each render
      switchInsight('why');
    }

    // ========== PRODUCT ROW RENDERING ==========
    function renderProductRows(rows) {
      productRowsEl.innerHTML = '';
      if (!Array.isArray(rows) || rows.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'status-message';
        empty.textContent = 'No products returned.';
        productRowsEl.appendChild(empty);
        return;
      }

      rows.forEach(row => {
        const wrapper = document.createElement('div');
        wrapper.className = 'category-row';

        const head = document.createElement('div');
        head.className = 'category-head';
        const title = document.createElement('div');
        title.className = 'category-name';
        title.textContent = row.category || 'Category';
        const descriptor = document.createElement('span');
        descriptor.className = 'section-subtitle';
        descriptor.textContent = 'Best pick + alternatives';
        const expandToggle = document.createElement('button');
        expandToggle.className = 'expand-toggle collapsed';
        expandToggle.setAttribute('aria-label', 'Toggle alternatives');
        expandToggle.textContent = '‚ñº';
        expandToggle.type = 'button';
        head.appendChild(title);
        head.appendChild(descriptor);
        head.appendChild(expandToggle);
        wrapper.appendChild(head);

        const rowContainer = document.createElement('div');
        rowContainer.className = 'product-row';

        const bestCard = createProductCard(row.best || {}, true);
        const badge = document.createElement('span');
        badge.className = 'best-badge';
        badge.textContent = 'Best option';
        bestCard.appendChild(badge);
        rowContainer.appendChild(bestCard);

        const altScroll = document.createElement('div');
        altScroll.className = 'alternatives-scroll';
        const altList = document.createElement('div');
        altList.className = 'alternatives-list';

        (row.alternatives || []).forEach(prod => {
          const card = createProductCard(prod, false);
          card.classList.add('alt-card');
          altList.appendChild(card);
        });

        // Attach expand/collapse handler
        expandToggle.addEventListener('click', (e) => {
          e.preventDefault();
          expandToggle.classList.toggle('collapsed');
          altList.classList.toggle('expanded');
        });

        altScroll.appendChild(altList);
        rowContainer.appendChild(altScroll);
        wrapper.appendChild(rowContainer);

        productRowsEl.appendChild(wrapper);
      });
    }

    // ========== RESULTS & UI UPDATES ==========
    function showAIResults(data) {
      statusEl.textContent = "";
      clarificationEl.classList.remove('active');
      
      // Show AI results
      aiResultsEl.classList.add('active');

      renderSections(data.sections || {});
      renderProductRows(data.products_by_category || []);

      // Scroll to results
      aiResultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ========== PRODUCT CARD GENERATION ==========
    function createProductCard(prod, isBest = false) {
      const safeType = prod.type || 'cassette';
      const card = document.createElement("a");
      card.className = "product-card" + (isBest ? " best-card" : "");
      card.href = prod.url || "#";
      card.target = "_blank";
      card.rel = "noopener noreferrer";

      const image = document.createElement("div");
      image.className = "product-image";
      if (safeType === 'cassette') {
        image.textContent = '‚öôÔ∏è';
      } else if (safeType === 'chain') {
        image.textContent = '‚õìÔ∏è';
      } else {
        image.textContent = 'üõ†Ô∏è';
      }

      const body = document.createElement("div");
      body.className = "product-body";

      const category = document.createElement("span");
      category.className = `product-category ${safeType}`;
      if (safeType === 'cassette') {
        category.textContent = 'Cassette';
      } else if (safeType === 'chain') {
        category.textContent = 'Chain';
      } else {
        category.textContent = 'Tool';
      }

      const name = document.createElement("div");
      name.className = "product-name";
      name.textContent = prod.name || 'Product';

      const meta = document.createElement("div");
      meta.className = "product-meta";
      meta.textContent = [prod.brand, prod.application].filter(Boolean).join(" ¬∑ ");

      const footer = document.createElement("div");
      footer.className = "product-footer";

      const price = document.createElement("div");
      price.className = "product-price";
      price.textContent = prod.price || "";

      const link = document.createElement("span");
      link.className = "product-link";
      link.innerHTML = "View ‚Üí";

      footer.appendChild(price);
      footer.appendChild(link);

      body.appendChild(category);
      body.appendChild(name);
      body.appendChild(meta);
      body.appendChild(footer);

      card.appendChild(image);
      card.appendChild(body);

      return card;
    }

    // ========== PAGE LOAD & EVENT LISTENERS ==========
    function triggerUpload() {
      uploadInput.click();
    }

    document.getElementById('upload-btn').addEventListener('click', triggerUpload);

    function setUploadStatus(text) {
      uploadStatus.textContent = text || '';
    }

    async function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxSize = 960;
            let { width, height } = img;
            if (width > height && width > maxSize) {
              height *= maxSize / width;
              width = maxSize;
            } else if (height > maxSize) {
              width *= maxSize / height;
              height = maxSize;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            if (!ctx) return reject(new Error('Canvas not supported'));
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(
              (blob) => {
                if (!blob) return reject(new Error('Compression failed'));
                const fr = new FileReader();
                fr.onloadend = () => {
                  const base64 = (fr.result || '').toString();
                  resolve(base64.replace(/^data:image\\/[^;]+;base64,/, ''));
                };
                fr.onerror = reject;
                fr.readAsDataURL(blob);
              },
              'image/jpeg',
              0.7
            );
          };
          img.onerror = () => reject(new Error('Could not read image'));
          img.src = event.target?.result?.toString() || '';
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    uploadInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        setUploadStatus('Please choose an image file.');
        compressedImage = null;
        return;
      }
      setUploadStatus('Compressing photo...');
      try {
        compressedImage = await compressImage(file);
        setUploadStatus(`Attached: ${file.name}`);
      } catch (err) {
        console.error(err);
        compressedImage = null;
        setUploadStatus('Upload failed. Try a different image.');
      }
    });

    // Allow Enter to submit (Shift+Enter for new line)
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSearch();
      }
    });
  </script>
</body>
</html>
