<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bike Components Shop ‚Äì AI Recommendations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #ffffff;
      --header-bg: #f8f9fa;
      --card-bg: #ffffff;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --search-bg: #f9fafb;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: var(--header-bg);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 0 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      background: rgba(248, 249, 250, 0.95);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      text-decoration: none;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-text {
      display: inline-flex;
      align-items: baseline;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .header-title {
      font-size: 1.45rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }

    .header-subtitle {
      font-size: 0.95rem;
      color: var(--muted);
      line-height: 1.2;
    }

    .nav {
      display: flex;
      gap: 1.25rem;
      list-style: none;
      flex-wrap: wrap;
    }

    .nav a {
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav a:hover {
      color: var(--accent);
    }

    /* Hero Search Section */
    .hero {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      padding: 1.5rem 1.5rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .hero-content {
      max-width: 980px;
      margin: 0 auto;
    }

    /* Search Mode Tabs on bar */
    .search-modes-inline {
      position: absolute;
      left: 0.6rem;
      top: 0.5rem;
      display: flex;
      gap: 0.4rem;
      z-index: 2;
    }

    .mode-tab {
      padding: 0.2rem 0.65rem;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--text);
      font-size: 0.82rem;
      font-weight: 600;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1.2;
    }

    .mode-tab:hover {
      border-color: var(--accent);
    }

    .mode-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }

    .mode-tab.disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    /* Search Container */
    .search-container {
      position: relative;
      max-width: 900px;
      margin: 0 auto;
    }

    .search-wrapper {
      position: relative;
      background: white;
      border: 2px solid var(--border);
      border-radius: 2rem;
      box-shadow: 0 4px 18px var(--shadow);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      padding-right: 0.35rem;
      padding-left: 6.5rem; /* space for tabs */
    }

    .search-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 4px 30px rgba(34, 197, 94, 0.2);
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 0.9rem 1.25rem;
      font-size: 0.98rem;
      background: transparent;
      resize: none;
      overflow: hidden;
      font-family: inherit;
      line-height: 1.5;
    }

    .search-input.multi-line {
      min-height: 3.6rem;
    }

    .search-button {
      width: 2.7rem;
      height: 2.7rem;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .search-button:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .search-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: scale(1);
    }

    /* Status Message */
    .status-message {
      text-align: center;
      margin-top: 1rem;
      color: var(--muted);
      font-size: 0.9rem;
      min-height: 1.5rem;
    }

    .status-message.error {
      color: #ef4444;
    }

    /* Clarification Section */
    .clarification {
      background: #fffbeb;
      border: 2px solid #fbbf24;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: none;
    }

    .clarification.active {
      display: block;
    }

    .clarification-title {
      font-weight: 600;
      margin-bottom: 1rem;
      color: #92400e;
    }

    .clarification-section {
      margin-bottom: 1rem;
    }

    .clarification-section:last-child {
      margin-bottom: 0;
    }

    .clarification-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #78350f;
      margin-bottom: 0.5rem;
    }

    .clarification-options {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .option-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #fbbf24;
      background: white;
      color: #92400e;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .option-btn:hover {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .option-selected {
      padding: 0.5rem 1rem;
      color: #15803d;
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem;
    }

    /* AI Results Section */
    .ai-results {
      display: none;
      margin-bottom: 1rem;
    }

    .ai-results.active {
      display: block;
    }

    .insight-tabs {
      display: flex;
      gap: 0.35rem;
      margin-bottom: 0.6rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.25rem;
    }

    .insight-tab {
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 0.6rem;
      padding: 0.45rem 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .insight-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }

    .insight-panels {
      background: #f9fafb;
      border: 1px solid var(--border);
      border-radius: 0.65rem;
      padding: 0.9rem 1rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05);
    }

    .insight-panel {
      display: none;
    }

    .insight-panel.active {
      display: block;
    }

    .info-title {
      font-weight: 700;
      margin-bottom: 0.35rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .info-list {
      margin: 0.25rem 0 0;
      padding-left: 1.1rem;
      color: var(--muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      background: #ecfdf3;
      color: #15803d;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    /* Product Rows */
    .products-section {
      margin-top: 1.5rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    .section-subtitle {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .category-row {
      margin-bottom: 1.5rem;
    }

    .category-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .category-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
    }

    .product-row {
      display: grid;
      grid-template-columns: minmax(240px, 300px) 1fr;
      gap: 0.8rem;
      align-items: stretch;
    }

    .best-card {
      border: 2px solid var(--accent);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.16);
      position: relative;
    }

    .best-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--accent);
      color: white;
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      font-weight: 700;
    }

    .alternatives-scroll {
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }

    .alternatives-list {
      display: flex;
      gap: 0.65rem;
      min-height: 100%;
    }

    .alt-card {
      min-width: 230px;
      max-width: 300px;
      flex: 0 0 auto;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .product-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      overflow: hidden;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
      display: block;
      position: relative;
    }

    .product-card:hover {
      box-shadow: 0 8px 24px var(--shadow);
      transform: translateY(-2px);
      border-color: var(--accent);
    }

    .product-image {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 3rem;
    }

    .product-body {
      padding: 1rem;
    }

    .product-category {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .product-category.chain {
      background: #fed7aa;
      color: #9a3412;
    }

    .product-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .product-meta {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .product-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
    }

    .product-link {
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    /* Sample Products Section */
    .sample-products {
      display: block;
    }

    .sample-products.hidden {
      display: none;
    }

    .category-section {
      margin-bottom: 2rem;
    }

    .category-title {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-title {
        font-size: 1.8rem;
      }

      .nav {
        display: none;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
      }

      .product-row {
        grid-template-columns: 1fr;
      }

      .search-modes {
        flex-direction: column;
        align-items: stretch;
      }

      .mode-tab {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">
        üö¥
        <span class="logo-text">
          <span class="header-title">BikeShop</span>
          <span class="header-subtitle">AI fit & catalog</span>
        </span>
      </a>
      <nav>
        <ul class="nav">
          <li><a href="#products">Products</a></li>
          <li><a href="#categories">Categories</a></li>
          <li><a href="#support">Support</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Hero Search Section -->
  <section class="hero">
    <div class="hero-content">
      <!-- Search Container -->
      <div class="search-container">
        <div class="search-wrapper">
          <div class="search-modes-inline">
            <button class="mode-tab disabled" id="search-tab" onclick="switchMode('search')">Search</button>
            <button class="mode-tab active" id="ai-tab" onclick="switchMode('ai')">AI</button>
          </div>
          <textarea 
            id="search-input" 
            class="search-input multi-line" 
            placeholder="Describe your bike and what you need... (e.g., 'I have a Shimano 11-speed gravel bike and need easier gears for climbs')"
            rows="1"
          ></textarea>
          <button id="search-btn" class="search-button" onclick="handleSearch()">
            ‚Üí
          </button>
        </div>
        <div id="status" class="status-message"></div>

        <!-- Clarification Section -->
        <div id="clarification" class="clarification">
          <div class="clarification-title" id="clarification-hint">Please select the missing information:</div>
          
          <div id="speed-section" class="clarification-section" style="display:none;">
            <div class="clarification-label">Drivetrain Speed:</div>
            <div id="speed-options" class="clarification-options"></div>
          </div>

          <div id="usecase-section" class="clarification-section" style="display:none;">
            <div class="clarification-label">Use Case:</div>
            <div id="usecase-options" class="clarification-options"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="main-content">
    <!-- AI Results (hidden by default) -->
    <div id="ai-results" class="ai-results">
      <div class="insight-tabs">
        <button class="insight-tab active" id="tab-why" onclick="switchInsight('why')">Why it fits</button>
        <button class="insight-tab" id="tab-workflow" onclick="switchInsight('workflow')">Workflow</button>
        <button class="insight-tab" id="tab-checklist" onclick="switchInsight('checklist')">Checklist</button>
      </div>
      <div class="insight-panels">
        <div class="insight-panel active" id="panel-why">
          <div class="info-title">Why it fits</div>
          <ul id="why-body" class="info-list"></ul>
        </div>
        <div class="insight-panel" id="panel-workflow">
          <div class="info-title">üõ†Ô∏è Suggested workflow</div>
          <ol id="workflow-list" class="info-list"></ol>
        </div>
        <div class="insight-panel" id="panel-checklist">
          <div class="info-title">‚úÖ Checklist</div>
          <ul id="checklist-list" class="info-list"></ul>
        </div>
      </div>

      <div class="section-header">
        <div>
          <h2 class="section-title">Recommended Products</h2>
          <p class="section-subtitle">Based on your requirements</p>
        </div>
      </div>
      <div id="product-rows"></div>
    </div>

    <!-- Sample Products (shown by default) -->
    <div id="sample-products" class="sample-products">
      <div class="category-section">
        <h3 class="category-title">üîß Featured Cassettes</h3>
        <div class="products-grid" id="sample-cassettes"></div>
      </div>

      <div class="category-section">
        <h3 class="category-title">‚õìÔ∏è Popular Chains</h3>
        <div class="products-grid" id="sample-chains"></div>
      </div>
    </div>
  </main>

  <script>
    // State
    let currentMode = 'ai';
    let selectedSpeed = null;
    let selectedUseCase = null;

    // Elements
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const statusEl = document.getElementById('status');
    const clarificationEl = document.getElementById('clarification');
    const aiResultsEl = document.getElementById('ai-results');
    const sampleProductsEl = document.getElementById('sample-products');
    const whyBody = document.getElementById('why-body');
    const workflowList = document.getElementById('workflow-list');
    const checklistList = document.getElementById('checklist-list');
    const productRowsEl = document.getElementById('product-rows');
    let activeInsight = 'why';

    // Switch between search and AI modes
    function switchMode(mode) {
      if (mode === 'search') {
        // Search is dummy for now
        return;
      }
      
      currentMode = mode;
      document.getElementById('search-tab').classList.toggle('active', mode === 'search');
      document.getElementById('ai-tab').classList.toggle('active', mode === 'ai');
      
      if (mode === 'ai') {
        searchInput.classList.add('multi-line');
        searchInput.placeholder = "Describe your bike and what you need... (e.g., 'I have a Shimano 11-speed gravel bike and need easier gears for climbs')";
        searchInput.rows = 3;
      } else {
        searchInput.classList.remove('multi-line');
        searchInput.placeholder = "Search for components...";
        searchInput.rows = 1;
      }
    }

    // Handle search/AI request
    async function handleSearch() {
      const problemText = searchInput.value.trim();
      
      if (!problemText) {
        statusEl.textContent = "Please describe your bike and project first.";
        statusEl.classList.add('error');
        return;
      }

      statusEl.classList.remove('error');
      statusEl.textContent = "Thinking...";
      searchBtn.disabled = true;

      const finalSpeed = selectedSpeed;
      const finalUseCase = selectedUseCase;

      try {
        const resp = await fetch("/api/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            problem_text: problemText,
            selected_speed: finalSpeed,
            selected_use_case: finalUseCase,
          }),
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || `Server error (${resp.status})`);
        }

        const data = await resp.json();

        // Persist any inferred values the backend already determined
        if (!selectedSpeed && data.inferred_speed) {
          selectedSpeed = data.inferred_speed;
        }
        if (!selectedUseCase && data.inferred_use_case) {
          selectedUseCase = data.inferred_use_case;
        }

        if (data.need_clarification) {
          statusEl.textContent = "Please select the missing information below.";
          renderClarification(data.options || {}, data.missing || []);
          return;
        }

        // Show AI results
        showAIResults(data);

      } catch (error) {
        statusEl.textContent = "Error: " + error.message;
        statusEl.classList.add('error');
      } finally {
        searchBtn.disabled = false;
      }
    }

    // Render clarification options
    function renderClarification(options, missingKeys) {
      clarificationEl.classList.add('active');
      
      const speedSection = document.getElementById('speed-section');
      const usecaseSection = document.getElementById('usecase-section');
      const speedOptions = document.getElementById('speed-options');
      const usecaseOptions = document.getElementById('usecase-options');

      // Update hint
      const stillMissing = missingKeys.filter(key => {
        if (key === "drivetrain_speed") return !selectedSpeed;
        if (key === "use_case") return !selectedUseCase;
        return true;
      });
      
      if (stillMissing.length > 1) {
        document.getElementById('clarification-hint').textContent = "Please select both options to continue:";
      } else {
        document.getElementById('clarification-hint').textContent = "Please select one option to continue:";
      }

      // Speed options
      if (missingKeys.includes("drivetrain_speed")) {
        speedSection.style.display = 'block';
        speedOptions.innerHTML = '';
        
        if (selectedSpeed) {
          const selected = document.createElement("div");
          selected.className = "option-selected";
          selected.textContent = `‚úì Selected: ${selectedSpeed}-speed`;
          speedOptions.appendChild(selected);
        } else {
          (options.speed_options || []).forEach((opt) => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.textContent = opt;
            btn.onclick = () => selectSpeed(opt);
            speedOptions.appendChild(btn);
          });
        }
      } else {
        speedSection.style.display = 'none';
      }

      // Use case options
      if (missingKeys.includes("use_case")) {
        usecaseSection.style.display = 'block';
        usecaseOptions.innerHTML = '';
        
        if (selectedUseCase) {
          const selected = document.createElement("div");
          selected.className = "option-selected";
          selected.textContent = `‚úì Selected: ${selectedUseCase}`;
          usecaseOptions.appendChild(selected);
        } else {
          (options.use_case_options || []).forEach((opt) => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.textContent = opt;
            btn.onclick = () => selectUseCase(opt);
            usecaseOptions.appendChild(btn);
          });
        }
      } else {
        usecaseSection.style.display = 'none';
      }
    }

    // Select speed option
    function selectSpeed(speed) {
      selectedSpeed = parseInt(speed);
      
      // Lock in the selection visually
      const speedOptions = document.getElementById('speed-options');
      speedOptions.innerHTML = '';
      const selected = document.createElement("div");
      selected.className = "option-selected";
      selected.textContent = `‚úì Selected: ${selectedSpeed}-speed`;
      speedOptions.appendChild(selected);
      
      handleSearch();
    }

    // Select use case option
    function selectUseCase(useCase) {
      selectedUseCase = useCase;
      
      // Lock in the selection visually
      const usecaseOptions = document.getElementById('usecase-options');
      usecaseOptions.innerHTML = '';
      const selected = document.createElement("div");
      selected.className = "option-selected";
      selected.textContent = `‚úì Selected: ${selectedUseCase}`;
      usecaseOptions.appendChild(selected);
      
      handleSearch();
    }

    function switchInsight(key) {
      activeInsight = key;
      const tabs = ['why', 'workflow', 'checklist'];
      tabs.forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('active', t === key);
        document.getElementById(`panel-${t}`).classList.toggle('active', t === key);
      });
    }

    function renderSections(sections) {
      const whyList = Array.isArray(sections.why_it_fits) ? sections.why_it_fits : [];
      const workflow = Array.isArray(sections.suggested_workflow) ? sections.suggested_workflow : [];
      const checklist = Array.isArray(sections.checklist) ? sections.checklist : [];

      // Why
      whyBody.innerHTML = '';
      whyList.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        whyBody.appendChild(li);
      });

      // Workflow
      workflowList.innerHTML = '';
      workflow.forEach(step => {
        const li = document.createElement('li');
        li.textContent = step;
        workflowList.appendChild(li);
      });

      // Checklist
      checklistList.innerHTML = '';
      checklist.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        checklistList.appendChild(li);
      });

      // Reset to first tab on each render
      switchInsight('why');
    }

    function renderProductRows(rows) {
      productRowsEl.innerHTML = '';
      if (!Array.isArray(rows) || rows.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'status-message';
        empty.textContent = 'No products returned.';
        productRowsEl.appendChild(empty);
        return;
      }

      rows.forEach(row => {
        const wrapper = document.createElement('div');
        wrapper.className = 'category-row';

        const head = document.createElement('div');
        head.className = 'category-head';
        const title = document.createElement('div');
        title.className = 'category-name';
        title.textContent = row.category || 'Category';
        const descriptor = document.createElement('span');
        descriptor.className = 'section-subtitle';
        descriptor.textContent = 'Best pick + alternatives';
        head.appendChild(title);
        head.appendChild(descriptor);
        wrapper.appendChild(head);

        const rowContainer = document.createElement('div');
        rowContainer.className = 'product-row';

        const bestCard = createProductCard(row.best || {}, true);
        const badge = document.createElement('span');
        badge.className = 'best-badge';
        badge.textContent = 'Best option';
        bestCard.appendChild(badge);
        rowContainer.appendChild(bestCard);

        const altScroll = document.createElement('div');
        altScroll.className = 'alternatives-scroll';
        const altList = document.createElement('div');
        altList.className = 'alternatives-list';

        (row.alternatives || []).forEach(prod => {
          const card = createProductCard(prod, false);
          card.classList.add('alt-card');
          altList.appendChild(card);
        });

        altScroll.appendChild(altList);
        rowContainer.appendChild(altScroll);
        wrapper.appendChild(rowContainer);

        productRowsEl.appendChild(wrapper);
      });
    }

    // Show AI results
    function showAIResults(data) {
      statusEl.textContent = "";
      clarificationEl.classList.remove('active');
      
      // Hide sample products, show AI results
      sampleProductsEl.classList.add('hidden');
      aiResultsEl.classList.add('active');

      renderSections(data.sections || {});
      renderProductRows(data.products_by_category || []);

      // Scroll to results
      aiResultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Create product card
    function createProductCard(prod, isBest = false) {
      const safeType = prod.type || 'cassette';
      const card = document.createElement("a");
      card.className = "product-card" + (isBest ? " best-card" : "");
      card.href = prod.url || "#";
      card.target = "_blank";
      card.rel = "noopener noreferrer";

      const image = document.createElement("div");
      image.className = "product-image";
      image.textContent = safeType === 'cassette' ? '‚öôÔ∏è' : '‚õìÔ∏è';

      const body = document.createElement("div");
      body.className = "product-body";

      const category = document.createElement("span");
      category.className = `product-category ${safeType}`;
      category.textContent = safeType === 'cassette' ? 'Cassette' : 'Chain';

      const name = document.createElement("div");
      name.className = "product-name";
      name.textContent = prod.name || 'Product';

      const meta = document.createElement("div");
      meta.className = "product-meta";
      meta.textContent = [prod.brand, prod.application].filter(Boolean).join(" ¬∑ ");

      const footer = document.createElement("div");
      footer.className = "product-footer";

      const price = document.createElement("div");
      price.className = "product-price";
      price.textContent = prod.price || "";

      const link = document.createElement("span");
      link.className = "product-link";
      link.innerHTML = "View ‚Üí";

      footer.appendChild(price);
      footer.appendChild(link);

      body.appendChild(category);
      body.appendChild(name);
      body.appendChild(meta);
      body.appendChild(footer);

      card.appendChild(image);
      card.appendChild(body);

      return card;
    }

    // Load sample products on page load
    async function loadSampleProducts() {
      // This would normally fetch from your product API
      // For now, we'll leave it empty or you can add sample data
      const sampleCassettes = [
        { name: "Shimano 105 CS-R7000 11-speed", brand: "Shimano", price: "from 44.99‚Ç¨", type: "cassette", url: "#", application: "Road, Gravel" },
        { name: "SRAM XG-1275 12-speed", brand: "SRAM", price: "from 189.99‚Ç¨", type: "cassette", url: "#", application: "MTB" },
        { name: "Shimano Ultegra CS-R8000 11-speed", brand: "Shimano", price: "from 38.99‚Ç¨", type: "cassette", url: "#", application: "Road" },
      ];

      const sampleChains = [
        { name: "Shimano CN-HG701-11 11-speed", brand: "Shimano", price: "from 24.99‚Ç¨", type: "chain", url: "#", application: "Road, MTB" },
        { name: "SRAM PC-1230 12-speed", brand: "SRAM", price: "from 39.99‚Ç¨", type: "chain", url: "#", application: "MTB" },
        { name: "KMC X11SL DLC 11-speed", brand: "KMC", price: "from 54.99‚Ç¨", type: "chain", url: "#", application: "Road, MTB" },
      ];

      const cassettesContainer = document.getElementById('sample-cassettes');
      const chainsContainer = document.getElementById('sample-chains');

      sampleCassettes.forEach(prod => {
        cassettesContainer.appendChild(createProductCard(prod));
      });

      sampleChains.forEach(prod => {
        chainsContainer.appendChild(createProductCard(prod));
      });
    }

    // Initialize
    loadSampleProducts();

    // Allow Enter to submit (Shift+Enter for new line)
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSearch();
      }
    });
  </script>
</body>
</html>
